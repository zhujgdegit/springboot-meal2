<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:replace="user/_fragments :: head(~{::title})">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diningcar</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <link rel="stylesheet" href="../../static/css/me.css" th:href="@{/css/me.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Naccl/blog-resource/github-badge.min.css">
</head>
<body class="site">
<!--navigation-->
<nav th:replace="user/_fragments :: menu(2)" class="ui inverted attached segment m-padded-tb-mini m-shadow-small">
</nav>

<div class="site-content">
    <!--Portlet Main Content-->
    <div class="m-padded-tb-big">
        <div class="ui container user">

            <div id="table-container" th:fragment="foodList">
                <table class="ui celled teal table m-text" style="text-align:center;">
                    <thead>
                    <th colspan="10"><h1 class="ui header" align="center">FOOD CARTS</h1></th>
                    <tr>
                        <th>NO</th>
                        <th>DISHNAME</th>
                        <!--              <th>ingredients</th>-->
                        <th>BASIC PRICE:YUAN</th>
                        <th>TOPPINGS</th>
                        <th>TYPE</th>
                        <th>SIZE</th>
                        <th>IMG</th>
                        <th>QUANTITY</th>
                        <th>TOTAL PRICE</th>
                        <th>REMARK</th>
                        <th>SELECT</th>
                        <th>OPERATE</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="food,iterStat : ${page.content}">
                        <td th:text="${iterStat.count}">1</td>
                        <td th:text="${food.name}" width="100px;" th:data-href="@{/detail/{id}(id=${food.id})}" style="cursor:pointer" onclick="window.location.href=this.getAttribute('data-href')">Scrambled eggs with Chinese chives</td>
                        <!--              <td th:text="${food.material}">Ingredients: 4 leeks (about 160g)</td>-->
                        <td th:text="${food.price}">8</td>
                        <td th:text="${!#strings.isEmpty(food.toppings) ? food.toppings + ' (+1)' : food.toppings}">
                            Process: Fried  Taste: clear flavor
                        </td>
                        <td th:text="${food.type.name}" width="70px;">Homemade dishes</td>
                        <!--              <td th:text="${food.size}" >small</td>-->
                        <td th:with="size_suffix=${food.size == 'Large' ? ' (+2)' : food.size == 'Medium' ? ' (+1)' : ''}"
                            th:text="${food.size + size_suffix}">
                            small
                        </td>

                        <td><img src="../../static/images2/jiachang/01.jpg" th:src="@{${food.picture}}" style="width: 150px;"></td>
                        <td th:text="${food.quantity}" >4</td>
                        <td th:text="${food.totalPrice}">2</td>
                        <td th:switch="${food.comment}">
                            <th:block th:case="-1">Popular dishes</th:block>
                            <th:block th:case="0">Chef Recommends</th:block>
                            <th:block th:case="*">Today's deals</th:block>
                        </td>
                        <td width="150px;">
                            <a onclick="del(this)" th:data-id="${food.id}" class="ui teal basic add button">Move out of the diningcar</a>
                        </td>
                        <td width="150px;">
                            <a onclick="opens(this)" th:data-id="${food.id}" id="openModal" class="ui teal button">Place an order</a>
                        </td>
                    </tr>
                    </tbody>
                </table>

                <!--footer-->
                <div class="ui bottom" th:if="${page.totalPages}>1">
                    <div class="ui middle aligned three column grid">
                        <div class="column">
                            <a onclick="page(this)" th:attr="data-page=${page.number}-1" th:unless="${page.first}"
                               class="ui blue inverted labeled icon button">
                                <i class="arrow left icon"></i>last page</a>
                        </div>
                        <div class="center aligned column">
                            <span class="m-margin-lr-small" th:text="|${page.number+1} / ${page.totalPages}|">2 / 7</span>
                        </div>
                        <div class="right aligned column">
                            <a onclick="page(this)" th:attr="data-page=${page.number}+1" th:unless="${page.last}"
                               class="ui blue inverted right labeled icon button">
                                Next page<i class="arrow right icon"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="ui modal" id="orderModal">
        <i class="close icon"></i>
        <div class="header">Order information</div>
        <div class="content">
            <form class="ui form" id="orderForm">
                <div class="field">
                    <label>delivery method</label>
                    <select class="ui dropdown" name="deliveryMethod" id="deliveryMethod" onchange="toggleAddressField()">
                        <option value="">Please choose the delivery method</option>
                        <option value="express">express delivery</option>
                        <option value="pickup">self pick-up</option>
                    </select>
                </div>
                <div class="field" id="addressField" style="display: none;">
                    <label>delivery address</label>
                    <select class="ui dropdown" name="address" id="selectElement">
                        <option value="">Please choose the delivery address</option>
                    </select>
                </div>
                <div class="field" id="deliveryTime" style="display: none;">
                    <label>delivery time</label>
                    <input type="time" name="deliveryTime">
                </div>
                <div class="field" id="arrivalTime" style="display: none;">
                    <label>arrival time</label>
                    <input type="time" name="arrivalTime">
                </div>
                <div class="field">
                    <label>payment method</label>
                    <select class="ui dropdown" name="paymentMethod">
                        <option value="">Please choose the payment method</option>
                        <option value="zfb">Alipay</option>
                        <option value="wx">WeChat</option>
                        <option value="cash">Cash</option>
                    </select>
                </div>
                <div class="field">
                    <label>delivery fee</label>
                    <input type="text" name="deliveryFee" value="5" readonly>
                </div>
                <div class="field">
                    <label>remark</label>
                    <input type="text" name="remark" value="remark">
                </div>
                <button class="ui button" type="submit">submit order</button>
            </form>
        </div>
    </div>
</div>
<div class="ui segment">
    <h3 id="totalAmount">total amount: ¥0</h3>
    <!-- All order buttons and modal Windows -->
    <button class="ui button primary" onclick="$('#allOrderModal').modal('show')">Full Order</button>

    <div class="ui modal" id="allOrderModal">
        <i class="close icon"></i>
        <div class="header">bulk order information</div>
        <div class="content">
            <form class="ui form" id="allOrdersForm">
                <div class="field">
                    <label>delivery method</label>
                    <select class="ui dropdown" name="deliveryMethod"  id="deliveryMethodAll" onchange="toggleAddressFieldAll()">
                        <option value="">Please choose the delivery method</option>
                        <option value="express">express delivery</option>
                        <option value="pickup">self pick-up</option>
                    </select>
                </div>
                <div class="field" id="addressFieldAll" style="display: none;">
                    <label>delivery address</label>
                    <select class="ui dropdown" name="address" id="selectElementAll">
                        <option value="">Please choose the delivery address</option>
                        <!--                  <option value="cash">  </option>-->
                    </select>
                    <!--            <input type="text" name="address" placeholder="请输入配送地址">-->
                </div>
                <div class="field" id="deliveryTimeAll" style="display: none;">
                    <label>delivery time</label>
                    <input type="time" name="deliveryTime">
                </div>
                <div class="field" id="arrivalTimeAll" style="display: none;">
                    <label>arrival time</label>
                    <input type="time" name="arrivalTime">
                </div>
                <div class="field">
                    <label>payment method</label>
                    <select class="ui dropdown" name="paymentMethod">
                        <option value="">Please choose the payment method</option>
                        <option value="zfb">Alipay</option>
                        <option value="wx">WeChat</option>
                        <option value="cash">Cash</option>
                    </select>
                </div>
                <div class="field">
                    <label>delivery fee</label>
                    <input type="text" name="deliveryFee" value="10" readonly>
                </div>
                <div class="field">
                    <label>remark</label>
                    <input type="text" name="remark" value="remark">
                </div>
                <div class="actions">
                    <button class="ui button green" type="submit">submit all orders</button>
                    <div class="ui button" onclick="$('#allOrderModal').modal('hide')">Cancel</div>
                </div>
            </form>
        </div>
    </div>

</div>

<!--底部footer-->
<footer th:replace="_fragments :: footer" class="ui inverted vertical segment">
</footer>

<!--/*/<th:block th:replace="user/_fragments :: myScript">/*/-->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.2/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
<!--/*/</th:block>/*/-->
<script>
    // $(document).ready(function() {
    //   // 初始化模态框
    //   $('.ui.modal').modal();
    //   var dataId = ""
    //   // 点击按钮打开模态框
    //   $('#openModal').click(function() {
    //     var element = $(this).data('food-id');
    //     console.log(element)
    //     if(element){
    //       dataId = element.getAttribute('data-id');
    //     }
    //     $('.ui.modal').modal('show');
    //   });
    //
    //   // 表单提交事件
    //   $('#orderForm').submit(function(event) {
    //     event.preventDefault(); // 阻止表单默认提交行为
    //     // 获取表单数据
    //     var formDataArray = $(this).serializeArray();
    //     formDataArray.push({ name: 'foodId', value: dataId });
    //     var formData = $.param(formDataArray);
    //     console.log(formData);
    //     // 发送 AJAX 请求
    //     $.ajax({
    //       url: '/user/order', // 替换为实际的后台接口地址
    //       method: 'POST',
    //       data: formData,
    //       success: function(response) {
    //         alert('订单提交成功！');
    //         $('.ui.modal').modal('hide');
    //
    //       },
    //       error: function(xhr, status, error) {
    //         console.error('请求出错:', error);
    //         alert('订单提交失败，请重试！');
    //       }
    //     });
    //   });
    // });


    function add(obj) {
        // objId = $(obj).attr('data-id');

        console.log(objId)
        // 显示模态框
        $('#myModal').modal('show');
    }

    function page(obj) {
        $("#table-container").load(/*[[@{/user/diningcar}]]*/"/user/diningcar", {
            page: $(obj).data("page")
        });
    }

    $(document).ready(function () {
        $.get("/user/getAddr", function (result) {
            console.log(result, '输出')
            if (result) {
                var options = result;
                var selectOpions = "";
                for (var i = 0; i < options.length; i++) {
                    selectOpions += '<option value="' + options[i][i] + '">' + options[i][i] + '</option>>';
                }
                $('#selectElement').append(selectOpions)
            } else {
                alert("Try it later!");
            }
        }, "json");

    })
    function calculateTotalAmount() {
        let total = 0;
        $('#table-container table tbody tr').each(function() {
            const price = parseFloat($(this).find('td:nth-last-child(4)').text()); // Let's say the total price is in the penultimate column
            total += price;
        });
        $('#totalAmount').text('Total amount: ¥' + total.toFixed(2));
    }

    function toggleAddressField() {
        var deliveryMethod = document.getElementById("deliveryMethod").value;
        var addressField = document.getElementById("addressField");
        var deliveryTime = document.getElementById("deliveryTime");
        var arrivalTime = document.getElementById("arrivalTime");

        if (deliveryMethod === "express") {
            addressField.style.display = "block";
            deliveryTime.style.display = "block";
        } else {
            addressField.style.display = "none";
            deliveryTime.style.display = "none";
        }
        if (deliveryMethod === "pickup") {
            arrivalTime.style.display = "block";
        } else {
            arrivalTime.style.display = "none";
        }
    }

    function toggleAddressFieldAll() {
        var deliveryMethodAll = document.getElementById("deliveryMethodAll").value;
        var addressFieldAll = document.getElementById("addressFieldAll");
        var deliveryTimeAll = document.getElementById("deliveryTimeAll");
        var arrivalTimeAll = document.getElementById("arrivalTimeAll");

        if (deliveryMethodAll === "express") {
            addressFieldAll.style.display = "block";
            deliveryTimeAll.style.display = "block";
        } else {
            addressFieldAll.style.display = "none";
            deliveryTimeAll.style.display = "none";
        }
        if (deliveryMethodAll === "pickup") {
            arrivalTimeAll.style.display = "block";
        } else {
            arrivalTimeAll.style.display = "none";
        }
    }


    $(document).ready(function () {
        // Initializes the modal box
        $('.ui.modal').modal();
        calculateTotalAmount(); // The total amount is calculated when the initial page loads
        $.get("/user/getAddr", function (result) {
            console.log(result, 'output')
            if (result) {
                var options = result;
                var selectOpions = "";
                for (var i = 0; i < options.length; i++) {
                    selectOpions += '<option value="' + options[i][i] + '">' + options[i][i] + '</option>>';
                }
                $('#selectElementAll').append(selectOpions)
            } else {
                alert("Try it later!");
            }
        }, "json");
        // Form submission event
        $('#orderForm').submit(function (event) {
            event.preventDefault(); // Prevents form default submission behavior
            // Get form data
            var formDataArray = $(this).serializeArray();
            var formData = {};
            formDataArray.forEach(function(item) {
                formData[item.name] = item.value.trim();  // Trim spaces and store each item in an object
            });

            // Check if all required fields are filled
            if (!formData.address || !formData.deliveryMethod || !formData.paymentMethod || formData.deliveryFee === '') {
                alert('Please fill in all required fields.');
                return;  // Stop the function if validation fails
            }

            // Get form data
            formDataArray.push({ name: 'foodId', value: foodId});
            var formData = $.param(formDataArray);
            // send AJAX request
            $.ajax({
                url: '/user/order', // Replace with the actual background interface address
                method: 'POST',
                data: formData,
                success: function (response) {
                    alert("Order submitted successfully");
                    $('.ui.modal').modal('hide');
                    // reload page
                    location.reload();
                },
                error: function (xhr, status, error) {
                    console.error('Request error:', error);
                    alert('Order submission failed, please try again!');
                }
            });
        });
    });
    var foodId = "";
    function opens(obj) {
        // Get the food id for clicking the button
        foodId = $(obj).attr('data-id');
        // Display mode box
        $('#orderModal').modal('show');
    }

    $('#allOrdersForm').submit(function(event) {
        event.preventDefault();

        // Create a JSON object to store the form data
        var formData = {};
        $(this).serializeArray().forEach(function(item) {
            formData[item.name] = item.value;  // Add each form element to the formData object
        });

        // Check if all required fields are filled
        if (!formData.address || !formData.deliveryMethod || !formData.paymentMethod || formData.deliveryFee === '') {
            alert('Please fill in all required fields.');
            return;  // Stop the function if validation fails
        }

        // send AJAX request
        $.ajax({
            url: '/user/submitAllOrders',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),  // Convert an object to a JSON string using json.stringify ()
            success: function(response) {
                alert("Successful order")
                $('#allOrderModal').modal('hide');
                // reload page
                location.reload();
            },
            error: function(xhr, status, error) {
                console.error('Request error:', error);
                alert('Order submission failed, please try again!');
            }
        });
    });



    function del(obj) {
        $.post("/user/del", {
            "id": $(obj).attr('data-id')
        }, function (result) {
            if (result.success) {
                location.reload(); // This will refresh the page
            } else {
                alert(result.message);
            }
        }, "json").fail(function (xhr, status, error) {
            console.error('Request failed:', error);
            alert('Failed to remove item, please try again.');
        });
    }
</script>

</body>
</html>