<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:replace="user/_fragments :: head(~{::title})">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historical Orders</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
  <link rel="stylesheet" href="../../static/css/me.css" th:href="@{/css/me.css}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Naccl/blog-resource/github-badge.min.css">
</head>
<body class="site">
<!-- Navigation -->
<nav th:replace="user/_fragments :: menu(2)" class="ui inverted attached segment m-padded-tb-mini m-shadow-small">
</nav>

<div class="site-content">
  <!-- Middle content -->
  <div class="m-padded-tb-big">
    <div class="ui container user" style="width:100%!important">

      <!-- Display when message is not empty -->
      <div class="ui success message" th:unless="${#strings.isEmpty(message)}">
        <i class="close icon"></i>
        <div class="header">Hint:</div>
        <p th:text="${message}">Operation successful!</p>
      </div>
      <!-- Search -->
      <div class="ui secondary segment form" style="width:100%!important;display: flex">
        <!-- Used for passing page for previous and next page -->
        <input type="hidden" name="page">

        <div class="inline fields">
          <div class="field">
            <input type="text" name="ordCode" placeholder="Enter order code">

            <!--              <div class="ui labeled action input">-->
            <!--                <input type="hidden" name="code" value="0"></div>-->

            <!--<i class="dropdown icon"></i>
            <div class="default text">All</div>
            <div class="menu">
                <div class="item" data-value="0">All</div>
                <div class="item" data-value="1" th:each="type:${types}" th:data-value="${type.id}" th:text="${type.name}">All</div>
            </div>-->
          </div>
        </div>

        <div class="field">
          <button type="button" id="search-btn" class="ui teal basic button"><i class="search icon"></i>Search</button>
        </div>
      </div>
    </div>

    <div id="table-container" th:fragment="orderList">
      <table class="ui celled teal table m-text" style="text-align:center;">
        <thead>
        <th colspan="13"><h1 class="ui header" align="center">HISTORICAL ORDERS</h1></th>
        <tr>
          <th>NO</th>
          <th>ORDER CODE</th>
          <th>DISHNAME</th>
          <th>PAYMENT METHOD</th>
          <th>SHIPPING METHOD</th>
          <th>SHIPPING ADDRESS</th>
          <th>DELIVERY FEES</th>
          <th>DELIVERY TIME</th>
          <th>PRICEï¼šYUAN</th>
          <th>NUMBER ORDERED</th>
          <th>STATUS</th>
          <th>OPERATE</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="order,iterStat : ${page}">
          <td th:text="${iterStat.count}"></td>
          <td th:text="${order.ordCode}"></td>
          <td th:text="${order.foodName}" width="100px;" th:data-href="@{/detail/{id}(id=${order.foodId})}" style="cursor:pointer" onclick="window.location.href=this.getAttribute('data-href')"></td>
          <td th:switch="${order.paymentMethod}">
            <th:block th:case="cash">Cash</th:block>
            <th:block th:case="zfb">Alipay</th:block>
            <th:block th:case="wx">WeChat</th:block>
          </td>
          <td th:switch="${order.deliveryMethod}">
            <th:block th:case="express">Express</th:block>
            <th:block th:case="pickup">Pickup</th:block>
          </td>
          <td th:text="${order.address}"></td>
          <td th:text="${order.deliveryFee}"></td>
          <td th:text="${order.deliveryTime}"></td>
          <td th:text="${order.price}"></td>
          <td th:text="${order.quantity}" width="70px;"></td>
          <td th:text="${order.status}">Status</td>
          <td width="250px;">
            <a onclick="opens(this)" th:data-id="${order.id}" id="openModal_${order.id}" class="ui teal button">
              <span>Review</span>
            </a>
            <a onclick="del(this)" th:data-href="@{/user/orders/deleteByCode(ordCode=${order.ordCode})}" class="ui teal basic button">Delete</a>
          </td>
        </tr>
        </tbody>
      </table>

    </div>
  </div>
</div>
</div>
<!-- Review Modal -->
<div id="ratingModal" class="ui modal">
  <i class="close icon"></i>
  <div class="header">Review</div>
  <div class="content">
    <form class="ui form">
      <div class="field

">
        <label>Rating</label>
        <div class="ui star rating" data-rating="0" data-max-rating="5" id="rating"></div>
      </div>
      <div class="field">
        <label>Comment</label>
        <textarea rows="2" id="comment"></textarea>
      </div>
    </form>
  </div>
  <div class="actions">
    <button id="submitRating" class="ui teal button">Submit Review</button>
    <button class="ui button" onclick="$('#ratingModal').modal('hide');">Cancel</button>
  </div>
</div>
<!-- Confirmation Modal -->
<div class="ui basic modal">
  <div class="ui icon header"><i class="trash alternate outline icon"></i>Delete</div>
  <div class="content"><h1>Are you sure you want to delete this order?</h1></div>
  <div class="actions">
    <div class="ui basic cancel inverted button"><i class="remove icon"></i>Cancel</div>
    <div id="ok" class="ui red ok inverted button"><i class="checkmark icon"></i>Delete</div>
  </div>
</div>

<!-- Footer -->
<footer th:replace="_fragments :: footer" class="ui inverted vertical segment">
</footer>

<!--/*/<th:block th:replace="user/_fragments :: myScript">/*/-->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.2/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
<!--/*/</th:block>/*/-->
<script>
  // Set timer to refresh the page, here it's refreshing every 20 seconds
  // setTimeout(function() {
  //   window.location.reload(1);
  // }, 20000);
</script>

<script>
  $('.message .close').on('click', function () {
    $(this).closest('.message').transition('fade');
  });
  var orderId="";
  $(document).ready(function () {
    // Initialize rating component
    $('#rating').rating();

    // Submit review
    $('#submitRating').click(function () {
      var rating = $('#rating').rating('get rating');
      var comment = $('#comment').val();

      // Check if rating and comment are empty
      if (rating === 0) {
        alert('Please provide a rating');
        return;
      }
      if (comment.trim() === '') {
        alert('Please enter a comment');
        return;
      }

      // Send review request
      $.post("/user/rating", {
        "orderId": orderId,
        "rating": rating,
        "comment": comment
      }, function (result) {
        alert("Review submitted")
        // Update button to "Reviewed"
        $('#ratingModal').modal('hide');
      });
    });

  });

  function opens(obj) {
    // Get orderId corresponding to the clicked button
    orderId = $(obj).data('id');
    // Set orderId for use when submitting review
    $('#submitRating').attr('data-order-id', orderId);
    // Show modal
    $('#ratingModal').modal('show');
  }
  function page(obj) {
    $("#table-container").load(/*[[@{/user/diningcar}]]*/"/user/diningcar", {
      page: $(obj).data("page")
    });
  }

  var ordCode = "";
  var url;
  $("#search-btn").click(function () {
    ordCode = $("[name='ordCode']").val();
    loadData();
  });


  function del(obj){
    url = $(obj).attr('data-href');
    $('.ui.basic.modal').modal('show');
  }
  $('#ok').click(function () {
    console.log(url,"shanchu")
    window.location.href = url;
  });
  function loadData() {
    $("#table-container").load(/*[[@{/search}]]*/"/user/orders/search", {
      ordCode: ordCode,
    });
  }
</script>

</body>
</html>